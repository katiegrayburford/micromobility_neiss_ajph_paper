---
title: "The Burden of Injuries Associated With E-Bikes, Powered Scooters, Hoverboards, and Bicycles in the United States: 2019‒2022."
date: "`r Sys.Date()`"
output: html_document
notes: must add in folder wish to save tables, plots, data in code
---

#loadpackages
```{r}

library("tidyverse")
library("dplyr")
library("data.table")
library("readr") 
library("survey")
library("janitor")
library("naniar")
library("gtsummary")
library("readxl")
library("ggplot2")
library("hexbin")
library("ggsurvey")
library("zoo")
library("gridExtra")
library("openxlsx")


```

#import data
```{r}

#load raw data
neiss2019 <- read_excel("data\\neiss_data_2019_2022\\neiss2019.xlsx")

neiss2020 <- read_excel("data\\neiss_data_2019_2022\\neiss2020.xlsx")

neiss2021 <- read_excel("data\\neiss_data_2019_2022\\neiss2021.xlsx")

neiss2022 <- read_excel("data\\neiss_data_2019_2022\\neiss2022.xlsx")

```

#merge dataframes
```{r}
# Add a new column to represent the original dataframe
neiss2019 <- neiss2019 %>%
  mutate(year = 2019)

neiss2020 <- neiss2020 %>%
  mutate(year = 2020)

neiss2021 <- neiss2021 %>%
  mutate(year = 2021)

neiss2022 <- neiss2022 %>%
  mutate(year = 2022)

# Append the dataframes
df_dirty <- bind_rows(neiss2019, neiss2020, neiss2021, neiss2022)
df <- bind_rows(neiss2019, neiss2020, neiss2021, neiss2022)

```


#clean data 

##sociodemographics + risk factors
```{r}
#1) tidy column names and select variables of interest
df <- df %>%
  janitor::clean_names() %>%
  select(cpsc_case_number, year, treatment_date, age, sex, race, hispanic, diagnosis,diagnosis_2, disposition, body_part, body_part_2,location, fire_involvement, alcohol,drug, product_1, product_2, product_3, narrative_1, stratum, psu, weight)


#2) assess missingness
pct_miss(df)
gg_miss_var(df, show_pct=TRUE)

#3) clean data

#YEAR
# year-quarter variable
df$date<-as.Date(df$treatment_date, format = "%m/%d/%y")
df$yrQtr<-as.yearqtr(df$date)

# character version year variable
df$yr<-format(df$date,"%y")

# turn date into month variable
df$month <- format(df$date, "%m/%y")

#CT
# create count variable for total survey counts
df$ct<-1	

##SEX
# create gender variable 
head(df$sex) # 1 is male, 2 is female, 3 is non-binary
df$male<-0
df$male[df$sex==1]<-1
df$male[df$sex==0]<-NA


#create sex cateogrical 
df <- df %>%
  mutate(sex_cat = case_when(
    sex == 0  ~ NA,
    sex ==1 ~ "Male",
    sex ==2 ~ "Female",
    sex ==3 ~ "Intersex/non-binary"))

table(df$sex_cat, useNA = "always")
as.factor(df$sex_cat)

##AGE 

#recode 1 to 23 months values to 1
df$age.1 <- ifelse(df$age > 200, 1, df$age)

# age groups 
df$ageGrp<-"pending"
df$ageGrp[df$age.1==0]<-NA
df$ageGrp[df$age.1>=1 & df$age.1<18]<-"1.LT18"
df$ageGrp[df$age.1>=18 & df$age.1<45]<-"2.GT17.LT45"
df$ageGrp[df$age.1>=45 & df$age.1<65]<-"3.GT44.LT65"
df$ageGrp[df$age.1>=65 & df$age.1<85]<-"4.GT64.LT85"
df$ageGrp[df$age.1>84]<-"5.GT84"

table(df$ageGrp)

#age_cat_all 
df <- df %>%
  mutate(age_cat_all= case_when(
    age.1 == 0 ~ NA,
    age.1 >0 & age.1 <5 ~ "<5",
    age.1 >=5 & age.1 <10 ~ "5-9",
    age.1 >=10 & age.1 <15 ~ "10-14", 
    age.1 >=15 & age.1 <18 ~ "15-17",
    age.1 >=18 & age.1 <45 ~ "18-44",
    age.1 >=45 & age.1 <65 ~ "45-64", 
    age.1 >=65 & age.1 <85 ~ "65-84",
    TRUE ~ ">84"))

as.factor(df$age_cat_all)
custom_levels <- c("<5", "5-9", "10-14", "15-17", "18-44", "45-64", "65-84", "<84")
df$age_cat_all <- factor(df$age_cat_all, levels = custom_levels)
as.factor(df$age_cat_all)

#PEDIATRIC AGE

# pediatric age groups 
df$pedAgeGrp[df$age.1==0] <-NA
df$pedAgeGrp[df$age.1 >0 & df$age.1<5]<-"0-4"
df$pedAgeGrp[df$age.1>=5 & df$age.1<10]<-"5-9"
df$pedAgeGrp[df$age.1>=10 & df$age.1<15]<-"10-14"
df$pedAgeGrp[df$age.1>=15 & df$age.1<18]<-"15-17"
df$pedAgeGrp[df$age.1>20]<-"Adult"

# age_cat_ped 
df <- df %>%
  mutate(age_cat_ped = case_when(
    age.1 == 0 ~ NA,
    age.1 >0 & age.1 <5 ~ "<5",
    age.1 >=5 & age.1 <10 ~ "5-9",
    age.1 >=10 & age.1 <15 ~ "10-14", 
    age.1 >=15 & age.1 <18 ~ "15-17",
    age.1 >20 ~ "Adult"))

as.factor(df$age_cat_ped)
custom_levels <- c("<5", "5-9", "10-14", "15-17", "Adult")
df$age_cat_ped <- factor(df$age_cat_ped, levels = custom_levels)
table(df$age_cat_ped, useNA ="always")

# RACE
# race_cat 
df <- df %>%
  mutate(race_cat = case_when(
    race ==0 ~ NA,
    race ==1 ~ "White",
    race ==2 ~ "Black/african american",
    race ==3 ~ "Other",
    race ==4 ~ "Asian",
    race ==5 ~ "American indian/alaska native",
    race ==6 ~ "Native hawaiian/pacific islander"))

as.factor(df$race_cat)
# hispanic_cat 

unique(df$hispanic)

df <- df %>%
  mutate(hispanic_cat = case_when(
    hispanic==0 ~ NA,
    hispanic==1 ~ "Yes",
    hispanic==2 ~ "No"))

as.factor(df$hispanic_cat)


# LOCATION
# location_cat 
df <- df %>%
  mutate(location_cat = case_when(
    location==0 ~ NA,
    location==1 | location==2 | location==3 | location==6 | location==7 ~ "Private property",
    location==4 ~ "Street or highway",
    location==5 ~ "Public property",
    location==8 ~ "School/daycare",
    location==9 ~ "Place of recreation or sport"))

as.factor(df$location_cat)

# fire_involvement_cat 
df <- df %>%
  mutate(fire_involvement_cat = case_when(
    fire_involvement==0 ~ "No",
    fire_involvement==1 | fire_involvement==2 | fire_involvement==3 ~ "Yes"))

as.factor(df$fire_involvement_cat)

# alcohol_cat 
df <- df %>%
  mutate(alcohol_cat = case_when(
    alcohol==0 ~ "No",
    alcohol==1 ~ "Yes"))

as.factor(df$alcohol_cat)

# drug_cat
df <- df %>%
  mutate(drug_cat = case_when(
    drug==0 ~ "No",
    drug==1 ~ "Yes"))


as.factor(df$drug_cat)

#HELMET 

## HELMET = NEGATIVE-----
# create negative helmet list- these are definite negatives
df$helmet_negative1 <- ifelse(str_detect(df$narrative_1, "\\-\\s?HELMET") , 1, 0)

## HELMET = NEGATIVE-----
# create negative helmet list- these are definite negatives
helmet_neg <- c("NO HELMET", "WITHOUT A HELMET", "WITHOUT HELMET", "NEGATIVE FOR HELMET", "NEGATIVE FOR A HELMET", 
"NOT HELMETED", "-HELMET", "- HELMET", "NOT WEARING HELMET", "NOT WEARING A HELMET", "UNHELMETED", 
"W/O HELMET", "DID NOT HAVE ON A HELMET", "NO WEARING HELMET", "DID NOT HAVE A HELMET", 
"DID NOT HAVE HELMET", "W/O A HELMET", "WITHOUT WEARING HELMET", "WITHOUT WEARING A HELMET", 
"REMOVED HELMET", "DENIED HELMET", "DENIED USE OF HELMET", "DENIED USE OF A HELMET", "HELMETLESS", 
"W/OUT HELMET", "DENIES HELMET", "WITH OUT HELMET", "WITH OUT A HELMET", "NOT WEAR A HELMET", 
"NOT WEAR HELMET", "WO A HELMET", "-HELMET", "NEGATIVE HELMET", "WIHTOUT A HELMET", "NOT WEARIING HELMET", "NOT WEARINNG A HELMET", "NOT WEARIG HELMET")


df <- df %>%
  mutate(helmet_negative2 = ifelse(Reduce(`|`, lapply(helmet_neg, str_detect, string = narrative_1)), 1, 0))

# create variable to combine the two positive variables and remove old variables
df$helmet_negative <- ifelse(df$helmet_negative1 == 1 | df$helmet_negative2 == 1, 1, 0)
df<- select(df, -c(helmet_negative1, helmet_negative2))


# spot check helment_negative = 0: these should all either be yes helmets or unclear
# df %>%
# dplyr::filter(helmet_negative==0) %>% View()

## HELMET = UNSURE-----

#first pull ?HELMET and ? HELMET (because of regex things)
df$helmet_unknown1 <- ifelse(str_detect(df$narrative_1, "\\?\\s?HELMET") , 1, 0) 
#first pull HELMET? 
df$helmet_unknown1.1 <- ifelse(str_detect(df$narrative_1, "HELMET\\?") , 1, 0)


# then pull all other unknown helmet phrases
# create unknown helmet list
# note: assuming that NS means not specified 
helmet_unk <- c("UNSURE IF HELMET", "UNSURE IF HELMETED", "UNSURE IF PT WEARING HELMET", 
"UNSURE IF PT WEARING A HELMET", "UNSURE IF PT WAS WEARING HELMET", 
"UNSURE IF PT WAS WEARING A HELMET", "UNKNOWN IF HELMET", "HELMET UNKNOWN", 
"UNKNOWN HELMET", "NO MENTION OF HELMET", "UNK HELMET", "HELMET UNK", 
"HELMET NS", "NS HELMET")

#create variable indicating presence of one of the phrases
df <- df %>%
  mutate(helmet_unknown2 = ifelse(Reduce(`|`, lapply(helmet_unk, str_detect, string = narrative_1)), 1, 0))

#create new variable to combine the two unknowns and remove old variables
df$helmet_unknown <- ifelse(df$helmet_unknown1 == 1 | df$helmet_unknown1.1 ==1 | df$helmet_unknown2 == 1, 1, 0)
df <- select(df, -c(helmet_unknown1,helmet_unknown1.1, helmet_unknown2))

#check
table(df$helmet_unknown)

# spot check helmet_negative = 0 and helmet_unknown =0: these should all be yes or some weird wording
# df_helmet %>%
#  dplyr::filter(helmet_unknown==0 & helmet_negative==0) %>% View()

## HELMET = POSITIVE----
# first pull +HELMET and + HELMET (because of regex things)
df$helmet_positive1 <- ifelse(str_detect(df$narrative_1, "\\+\\s?HELMET") , 1, 0)
# first pull + FUll HELMET and +FULL HELMET (because of regex things)
df$helmet_positive1.1 <- ifelse(str_detect(df$narrative_1, "\\+\\s?FULL HELMET") , 1, 0)
# first pull + FUll BIKE HELMET and +FULL BIKE HELMET (because of regex things)
df$helmet_positive1.2 <- ifelse(str_detect(df$narrative_1, "\\+\\s?FULL BIKE HELMET") , 1, 0)
# first pull + BIKE HELMET and +BIKE HELMET (because of regex things)
df$helmet_positive1.3 <- ifelse(str_detect(df$narrative_1, "\\+\\s?BIKE HELMET") , 1, 0)
# first pull & HELMET (because of regex things)
df$helmet_positive1.4 <- ifelse(str_detect(df$narrative_1, "\\&\\s?HELMET") , 1, 0)
# first pull + HELMEMT (because of regex things)
df$helmet_positive1.5 <- ifelse(str_detect(df$narrative_1, "\\+\\s?HELMEMT") , 1, 0)

# create positive list and pull all records matching
helmet_pos <- c("WITH A HELMET", "WITH HELMET", "POSITIVE FOR HELMET", "POSITIVE FOR A HELMET", "HELMETED", 
"WEARING HELMET", "WEARING A HELMET", "W/ HELMET", "W HELMET", "WORE HELMET", "W/HELMET", 
"W/ A HELMET", "HAD ON A HELMET", "HAD ON HELMET", "HAD HELMET", "HAD A HELMET", "HIS HELMET", 
"HER HELMET", "PT HELMET", "PTS HELMET", "WAS WEARING A HELMET", ",HELMET,", "CRACKED HELMET", 
"CRACKING HELMET", "HELMET CRACKED", "HELMET ON", "BROKE HELMET", "HELMET BROKE", "BREAKING HELMET", 
"POSITIVE HELMET", "WORE HELMET", "WEARING A BIKE HELMET", "WEARING A FULL FACE HELMET", 
"WEARING FULL FACE HELMET", "INCLUDING HELMET", " FULL HELMET", "PT'S HELMET", 
"HELMET FELL", "SMASHED HELMET", "PLUS HELMET", "HELMET WAS FRACTURED", "HELMET WAS BROKEN", 
 "WEARING BIKE HELMET", "ENDORSES HELMET", "HELMET WENT OFF", 
"FULL FACE MASK HELMET", "& HELMET", "HELMET WAS REPORTED TO BE CRACKED", "HELMETD", "WHELMET")


df <- df %>%
  mutate(helmet_positive2 = ifelse(Reduce(`|`, lapply(helmet_pos, str_detect, string = narrative_1)), 1, 0))

# create variable to combine the two positive variables and remove old variables
df$helmet_positive3 <- ifelse(df$helmet_positive1 == 1 | df$helmet_positive1.1 == 1 | df$helmet_positive1.2  == 1 | df$helmet_positive1.3 == 1| df$helmet_positive1.4 == 1|  df$helmet_positive1.5 == 1|df$helmet_positive2 == 1, 1, 0)
df<- select(df, -c(helmet_positive1, helmet_positive1.1,helmet_positive1.2,helmet_positive1.3, helmet_positive1.4,helmet_positive1.5, helmet_positive2))

# subset only the positives that have not already been labeled as negative or unknown
df$cant_be_pos <- ifelse(df$helmet_negative == 1 | df$helmet_unknown == 1, 1, 0)
df$helmet_positive <- ifelse(df$helmet_positive3 == 1 & df$cant_be_pos == 0, 1, 0)

df<- select(df, -c(helmet_positive3, cant_be_pos))

#check
table(df$helmet_positive)


nrow(df) - (sum(df$helmet_negative==1) + 
  sum(df$helmet_unknown==1) + sum(df$helmet_positive==1))


# Create a new variable 'helmet_unknown_all' for all of the unknowns (includes the "helmet_unknown" variable)
df$helmet_unknown_all <- ifelse(df$helmet_positive != 1 & df$helmet_negative != 1, 1, 0)


```

##outcome variable cleaning

```{r}
#DISPOSTION


# death variable (0 = no, 1 = yes)
df$death<-0
df$death[df$disposition==8]<-1
sum(df$death) #1110

# hospitalization (0 = no, 1 = yes)
df$admitted<-0
df$admitted[df$disposition==4]<-1
sum(df$admitted) #137324

# treated/transferred/admitted (0 = no, 1 = yes)
df$treated<-0
df$treated[df$disposition==4 | df$disposition==2]<-1
sum(df$treated) #150662

# disposition_cat 
df <- df %>%
  mutate(disposition_cat = case_when(
    disposition==2 | disposition==4 ~ "Treated/transferred/admitted",
    disposition==1 ~ "Treated/released",
    disposition==8 ~ "Dead",
    disposition==5 | disposition==6 ~ "Other", 
    disposition==9 ~ NA))


table(df$disposition_cat,useNA ="always")
as.factor(df$disposition_cat)


# DIAGNOSIS 

# Concussions
 df$concussions<-0
 df$concussions[df$diagnosis==52 | df$diagnosis_2==52]<-1
sum(df$concussions)

# Concussions + head injury
# head
df$concussions_head<-0
df$concussions_head[df$diagnosis==52 | df$diagnosis_2==52 & df$body_part==75 | df$body_part_2==75]<-1
sum(df$concussions_head)


# Internal Organ Injuries
df$internal<-0
df$internal[df$diagnosis==62 | df$diagnosis_2==62]<-1
sum(df$internal)

# Fracture
df$fx<-0
df$fx[df$diagnosis==57 | df$diagnosis_2==57]<-1
sum(df$fx)

# Soft Tissue Injuries (strain, sprain, contusion, abrasion, laceration, avulsion)
df$softTissue<-0
df$softTissue[df$diagnosis==64 | df$diagnosis==59 |df$diagnosis==53 | df$diagnosis ==72 | df$diagnosis_2==64 | df$diagnosis_2==59 |df$diagnosis_2==53 | df$diagnosis_2 ==72]<-1

# Burns (electrical, no specified, scald, chemical, thermal, radiation)
df$burns<-0
df$burns[df$diagnosis==46 | df$diagnosis==47 |df$diagnosis==48 | df$diagnosis==49 | df$diagnosis==51 | df$diagnosis == 73| df$diagnosis_2==46 | df$diagnosis_2==47 |df$diagnosis_2==48 | df$diagnosis_2==49 | df$diagnosis_2==51 | df$diagnosis_2 == 73]<-1


#BODY PART (new variable)
# head
df$head<-0
df$head[df$body_part==75 | df$body_part_2==75]<-1
sum(df$head)

table(df$head, df$concussions)

# MOTOR VEHICLE INDICATOR
# grep narrative 1
motorvehicle<-grep(c("car|vehicle|truck|bus|suv"), df$narrative_1, ignore.case = TRUE)
length(motorvehicle) # 122850
df$motorvehicle<-0
df$motorvehicle[motorvehicle]<-1
sum(df$motorvehicle) # 122850

# COLLISION WITH PEDESTRIAN INDICATOR
ped<-grep(c("pedestrian"), df$narrative_1, ignore.case = TRUE)
length(ped) # 668
df$ped<-0
df$ped[ped]<-1
sum(df$ped) #668
```

## 2019 micromobility variables

powered scooter, hoverboard, e-bike, bikes
```{r}

#Process 2019 separately bc product codes changed
#to get correct ebike, bike, scooter product code for 2019
#*in 2020 discontinued 1329 and 5042 (scooter, powered) replaced with 5022, 5023 (unpowered), 5024
df_19 <- df %>%
  filter(year %in% c("2019"))

df_20_21_22 <- df %>%
  filter(year %in% c("2020", "2021", "2022"))

#note: all coded as 0=no, 1=yes

#POWERED SCOOTER (5042)
# scooter code
df_19$Code5042<-0
df_19$Code5042[df_19$product_1==5042 | df_19$product_2==5042 | df_19$product_3==5042]<-1

sum(df_19$Code5042) 

# scooter indicator
scooter1<-grep(c("scooter"), df_19$narrative_1, ignore.case = TRUE)
length(scooter1) 
df_19$scooter1<-0
df_19$scooter1[scooter1]<-1
sum(df_19$scooter1) 


sum(df_19$scooter1==1 & df_19$Code5042==1) 

df_19$scooter<-0
df_19$scooter[df_19$scooter1==1 & df_19$Code5042==1]<-1

# remove interim variables
df_19<-df_19[,!names(df_19) %in% c("scooter1")]

table(df_19$scooter) 

#  powered skateboard indicator
skateboard1<-grep(c("skate|skate board|skateboard"),df_19$narrative_1, ignore.case = TRUE)
length(skateboard1) 
df_19$skateboard1<-0
df_19$skateboard1[skateboard1]<-1
sum(df_19$skateboard1) 


sum(df_19$skateboard1==1 & df_19$Code5042==1)

df_19$skateboard<-0
df_19$skateboard[df_19$skateboard1==1 & df_19$Code5042==1]<-1

# remove interim variables
df_19<-df_19[,!names(df_19) %in% c("skateboard1")]

table(df_19$skateboard) 


#HOVERBOARD - 
# hoverboard variable
hover1<-grep(c("hoverboard|hooverboard|hover board|hoover board|hoverbaord|hooverbaord|hover boad|hoverboad,|hoverbrd"), df_19$narrative_1, ignore.case = TRUE)
length(hover1) 
df_19$hover1<-0
df_19$hover1[hover1]<-1
sum(df_19$hover1) 

sum(df_19$hover1==1 & df_19$Code5042==1) 

df_19$hover<-0
df_19$hover[df_19$hover1==1 & df_19$Code5042==1]<-1

# remove interim variables
df_19<-df_19[,!names(df_19) %in% c("hover1")]

# powered bike code
df_19$Codes5035.3215<-0
df_19$Codes5035.3215[df_19$product_1==5035 | df_19$product_2==5035 | df_19$product_3==5035| df_19$product_1==3215 | df_19$product_2==3215 |df_19$product_3==3215]<-1

sum(df_19$Codes5035.3215) 

# E-BIKE (5035, 3215)

#search narratives for bike or bicycle
ebike1<-grep(c("bike*| bicycle*"), df_19$narrative_1, ignore.case = TRUE)
length(ebike1) 
df_19$ebike1<-0
df_19$ebike1[ebike1]<-1
sum(df_19$ebike1) #13005

#search narratives for elec or batt or motor
ebike2<-grep(c("elect*|batt*|motor*"), df_19$narrative_1, ignore.case = TRUE)
length(ebike2) 
df_19$ebike2<-0
df_19$ebike2[ebike2]<-1
sum(df_19$ebike2)#11571

#combine so that have narratives that contain ebike 1 AND ebike2 conditions
df_19$ebike12<-0
df_19$ebike12[df_19$ebike1==1 & df_19$ebike2==1]<-1
sum(df_19$ebike12) #367

#combine narratives and codes
sum(df_19$ebike2==1 & df_19$Codes5035.3215==1) #152

df_19$ebike<-0
df_19$ebike[df_19$ebike12==1 & df_19$Codes5035.3215==1]<-1

# remove interim variables
df_19<-df_19[,!names(df_19) %in% c("ebike1", "ebike2", "ebike12")]

table(df_19$ebike) # 152

#BIKE 

# identify codes for bicycles (code 5040) and mountain bikes (code 5033)

df_19$bike1<-0
df_19$bike1[df_19$product_1==5040 | df_19$product_2==5040 | df_19$product_3==5040]<-1

df_19$bike2<-0
df_19$bike2[df_19$product_1==5033 | df_19$product_2==5033 | df_19$product_3==5033]<-1

df_19$bike<-0
df_19$bike[df_19$bike1==1 | df_19$bike2==1]<-1

# remove interim variables
df_19<-df_19[,!names(df_19) %in% c("bike1", "bike2","Code5042", "Codes5035.3215")]

sum(df_19$bike)

```
## 2020-2022 micromobility variables

e-scooter, hoverboard, e-bike, bikes
```{r}

#note: all coded as 0=no, 1=yes

#POWERED SCOOTER (5022, new code)
# scooter code
df_20_21_22$Code5042<-0
df_20_21_22$Code5042[df_20_21_22$product_1==5022 | df_20_21_22$product_2==5022 | df_20_21_22$product_3==5022]<-1

sum(df_20_21_22$Code5042) 

# scooter indicator
scooter1<-grep(c("scooter"), df_20_21_22$narrative_1, ignore.case = TRUE)
length(scooter1) 
df_20_21_22$scooter1<-0
df_20_21_22$scooter1[scooter1]<-1
sum(df_20_21_22$scooter1) 

sum(df_20_21_22$scooter1==1 & df_20_21_22$Code5042==1) 

df_20_21_22$scooter<-0
df_20_21_22$scooter[df_20_21_22$scooter1==1 & df_20_21_22$Code5042==1]<-1

# remove interim variables
df_20_21_22<-df_20_21_22[,!names(df_20_21_22) %in% c("scooter1")]

table(df_20_21_22$scooter) 

#  powered skateboard (5025, new code for powered skateboard and hoverboard)

df_20_21_22$Code5025<-0
df_20_21_22$Code5025[df_20_21_22$product_1==5025 | df_20_21_22$product_2==5025 | df_20_21_22$product_3==5025]<-1


skateboard1<-grep(c("skate|skate board|skateboard"),df_20_21_22$narrative_1, ignore.case = TRUE)
length(skateboard1) 
df_20_21_22$skateboard1<-0
df_20_21_22$skateboard1[skateboard1]<-1
sum(df_20_21_22$skateboard1) 


sum(df_20_21_22$skateboard1==1 & df_20_21_22$Code5025==1)

df_20_21_22$skateboard<-0
df_20_21_22$skateboard[df_20_21_22$skateboard1==1 & df_20_21_22$Code5025==1]<-1

# remove interim variables
df_20_21_22<-df_20_21_22[,!names(df_20_21_22) %in% c("skateboard1")]

table(df_20_21_22$skateboard) 


#HOVERBOARD - 
# hoverboard variable use 5025
hover1<-grep(c("hoverboard|hooverboard|hover board|hoover board|hoverbaord|hooverbaord|hover boad|hoverboad,|hoverbrd"), df_20_21_22$narrative_1, ignore.case = TRUE)
length(hover1) 
df_20_21_22$hover1<-0
df_20_21_22$hover1[hover1]<-1
sum(df_20_21_22$hover1) 

sum(df_20_21_22$hover1==1 & df_20_21_22$Code5025==1) 

df_20_21_22$hover<-0
df_20_21_22$hover[df_20_21_22$hover1==1 & df_20_21_22$Code5025==1]<-1

# remove interim variables
df_20_21_22<-df_20_21_22[,!names(df_20_21_22) %in% c("hover1")]

table(df_20_21_22$hover) 


#ELECTRIC BIKE

# powered bike code
df_20_21_22$Codes5035.3215<-0
df_20_21_22$Codes5035.3215[df_20_21_22$product_1==5035 | df_20_21_22$product_2==5035 | df_20_21_22$product_3==5035| df_20_21_22$product_1==3215 | df_20_21_22$product_2==3215 |df_20_21_22$product_3==3215]<-1

sum(df_20_21_22$Codes5035.3215) 

# E-BIKE (5035, 3215)

#search narratives for bike or bicycle
ebike1<-grep(c("bike*| bicycle*"), df_20_21_22$narrative_1, ignore.case = TRUE)
length(ebike1) 
df_20_21_22$ebike1<-0
df_20_21_22$ebike1[ebike1]<-1
sum(df_20_21_22$ebike1)

#search narratives for elec or batt or motor
ebike2<-grep(c("elect*|batt*|motor*"), df_20_21_22$narrative_1, ignore.case = TRUE)
length(ebike2) 
df_20_21_22$ebike2<-0
df_20_21_22$ebike2[ebike2]<-1
sum(df_20_21_22$ebike2)

#combine so that have narratives that contain ebike 1 AND ebike2 conditions
df_20_21_22$ebike12<-0
df_20_21_22$ebike12[df_20_21_22$ebike1==1 & df_20_21_22$ebike2==1]<-1
sum(df_20_21_22$ebike12) 

#combine narratives and codes
sum(df_20_21_22$ebike2==1 & df_20_21_22$Codes5035.3215==1) 

df_20_21_22$ebike<-0
df_20_21_22$ebike[df_20_21_22$ebike12==1 & df_20_21_22$Codes5035.3215==1]<-1

# remove interim variables
df_20_21_22<-df_20_21_22[,!names(df_20_21_22) %in% c("ebike1", "ebike2", "ebike12")]

table(df_20_21_22$ebike) 

#BIKE 

# identify codes for bicycles (code 5040) and mountain bikes (code 5033)

df_20_21_22$bike1<-0
df_20_21_22$bike1[df_20_21_22$product_1==5040 | df_20_21_22$product_2==5040 | df_20_21_22$product_3==5040]<-1

df_20_21_22$bike2<-0
df_20_21_22$bike2[df_20_21_22$product_1==5033 | df_20_21_22$product_2==5033 | df_20_21_22$product_3==5033]<-1

df_20_21_22$bike<-0
df_20_21_22$bike[df_20_21_22$bike1==1 | df_20_21_22$bike2==1]<-1

# remove interim variables
df_20_21_22<-df_20_21_22[,!names(df_20_21_22) %in% c("bike1", "bike2", "Code5042","Codes5035.3215")]

sum(df_20_21_22$bike)

```

##stack 2019 and 2020-2023 data
```{r}

# Find common vars
common_vars <- intersect(names(df_19), names(df_20_21_22))

# Subset both dataframes to include only common variables
df1_subset <- df_19[, common_vars, drop = FALSE]
df2_subset <- df_20_21_22[, common_vars, drop = FALSE]


#stack 2019 and 2020-2023 data
df_clean <- rbind(df1_subset, df2_subset)

names(df_clean)

#Duplicate issue (11/30/2023 update)
#decision to remove the duplicates from DF

#remove skateboard
df_clean<- df_clean %>%
  select(-c("skateboard"))

#note: use df_clean_with_dups to get total numbers of injuries in raw data
df_clean_with_dups <-df_clean

#remove duplicates (multiple modes reported) #160 in filtered dataframe
df_clean <- df_clean[
  !(
    df_clean$scooter == 1 & 
    (df_clean$bike == 1 | df_clean$ebike == 1 |  df_clean$hover == 1) |
    df_clean$bike == 1 & 
    (df_clean$scooter == 1 | df_clean$ebike == 1 | df_clean$hover == 1) |
    df_clean$ebike == 1 & 
    (df_clean$scooter == 1 | df_clean$bike == 1  | df_clean$hover == 1) |
    df_clean$hover == 1 & 
    (df_clean$scooter == 1 | df_clean$bike == 1 | df_clean$ebike == 1)
  ),
]

```


#analysis

###descriptive frequencies
```{r}
surv<-svydesign(
		id = ~psu ,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_clean
	)

surv
################################################################################################
# DESCRIPTIVES AND DEMOGRAPHICS
 ################################################################################################

################################################################################################

# ALL INJURIES COUNT
(totalCount<-svytotal(~ct, surv, vartype = c( 'ci' , 'se' )))

confint(totalCount)


# ALL MICROMOBILITY COUNT
(totalCount<- svytotal(~ct, subset(surv, scooter==1 | ebike==1 | bike==1 | hover==1), vartype = c('ci', 'se')))
totalCount
confint(totalCount)

# ALL MICROMOBILITY COUNT
(propburns<- svyratio(~burns, ~ct, subset(surv, scooter==1 | ebike==1 | bike==1 | hover==1), vartype = c('ci', 'se')))
propburns

confint(propburns)

################################################################################################

# Powered SCOOTER COUNT
(scooterCount<-svytotal(~scooter, surv, vartype = c( 'ci' , 'se' )))

confint(scooterCount)

################################################################################################

# PROPORTION SCOOTER OF ALL INJURIES
(propScooter<-svyratio(~scooter, ~ct, surv))

propScooter$ratio*1000

propScooter$var*1000

(propScooterCI<-confint(propScooter))

propScooterCI*1000
```


```{r}
################################################################################################

# Hover Board COUNT
(hoverCount<-svytotal(~hover, surv, vartype = c( 'ci' , 'se' )))

confint(hoverCount)

################################################################################################

# PROPORTION HOVER OF ALL INJURIES
(prophover<-svyratio(~hover, ~ct, surv))

prophover$ratio*1000

prophover$var*1000

(prophoverCI<-confint(prophover))

prophoverCI*1000
```


```{r}
################################################################################################

# EBIKE COUNT
(ebikeCount<-svytotal(~ebike, surv, vartype = c( 'ci' , 'se' )))

confint(ebikeCount)


################################################################################################

# PROPORTION EBIKE OF ALL INJURIES
(propEbike<-svyratio(~ebike, ~ct, surv))

propEbike$ratio*1000

propEbike$var*1000

(ebkikeCI<-confint(propEbike))

ebkikeCI*1000
```


```{r}
################################################################################################
# BIKE COUNT AND PROPORTION

(bikeCount<-svytotal(~bike, surv, vartype = c( 'ci' , 'se' )))

confint(bikeCount)

(propBike<-svyratio(~bike, ~ct, surv))

propBike$ratio*1000

propBike$var*1000

(propBikeCI<-confint(propBike))

ebkikeCI*1000

propBikeCI*10000
```


```{r}
################################################################################################

# AGE SCOOTER
(ageScoot<-svymean(~age, subset(surv, scooter==1), vartype = c( 'ci' , 'se' )))

confint(ageScoot)
```


```{r}
################################################################################################

# AGE hover
(agehov<-svymean(~age, subset(surv, hover==1), vartype = c( 'ci' , 'se' )))


confint(agehov)
```


```{r}
################################################################################################


# AGE EBIKE
(ageEbike<-svymean(~age, subset(surv, ebike==1), vartype = c( 'ci' , 'se' )))


confint(ageEbike)
```


```{r}
################################################################################################

# AGE BIKE
(ageBike<-svymean(~age, subset(surv, bike==1), vartype = c( 'ci' , 'se' )))

confint(ageBike)
```


```{r}
################################################################################################

# ALL AGE
age<-svymean(~age, surv, vartype = c( 'ci' , 'se' ))
age

confint(age)

################################################################################################
# AGE GROUPS SCOOTERS

(ageGroupPropScooter<-svymean(~ct+ageGrp, subset(surv, scooter==1), na.rm=T))

((ageGroupPropCIScooter<-confint(ageGroupPropScooter)))


(ageGroupProphover<-svymean(~ct+ageGrp, subset(surv, hover==1), na.rm=T))

((ageGroupPropCIhover<-confint(ageGroupProphover)))


# AGE GROUPS EBIKES

(ageGroupPropEbike<-svymean(~ct+ageGrp, subset(surv, ebike==1), na.rm=T))

((ageGroupPropCIEbike<-confint(ageGroupPropEbike)))

# age group all 
ageGroupProp <- svymean(~ct + ageGrp, surv, na.rm = TRUE)
ageGroupProp
 

((ageGroupPropCI<-confint(ageGroupProp)))

(ageGroupPropBike<-svymean(~ct+ageGrp, subset(surv, bike==1), na.rm=T))

((ageGroupPropCIBike<-confint(ageGroupPropBike)))

```

##descriptive figures

## figure 1

Figure 1. Percentage of Bicycle, E-Bike, Hoverboard, and Powered Scooter Injuries by Age: National Electronic
Injury Surveillance System, United States, 2019–2022
```{r}

################################################################################################
# AGE GROUPS SCOOTERS

(ageGroupPropScooter<-svymean(~ct+age_cat_all, subset(surv, scooter==1), na.rm=T))

((ageGroupPropCIScooter<-confint(ageGroupPropScooter)))


(ageGroupProphover<-svymean(~ct+age_cat_all, subset(surv, hover==1), na.rm=T))

((ageGroupPropCIhover<-confint(ageGroupProphover)))


# AGE GROUPS EBIKES

(ageGroupPropEbike<-svymean(~ct+age_cat_all, subset(surv, ebike==1), na.rm=T))

((ageGroupPropCIEbike<-confint(ageGroupPropEbike)))

# age group all 
ageGroupProp <- svymean(~ct + age_cat_all, surv, na.rm = TRUE)
ageGroupProp
 

((ageGroupPropCI<-confint(ageGroupProp)))

(ageGroupPropBike<-svymean(~ct+age_cat_all, subset(surv, bike==1), na.rm=T))

((ageGroupPropCIBike<-confint(ageGroupPropBike)))

##

(scootersAgeGrps<-bind_cols(as.data.frame(ageGroupPropScooter),as.data.frame(ageGroupPropCIScooter)))
scootersAgeGrps <- scootersAgeGrps[c(1,2,8,4,5,6,7,9,3),]

(ebikesAgeGrps<-bind_cols(as.data.frame(ageGroupPropEbike),as.data.frame(ageGroupPropCIEbike)))
ebikesAgeGrps <- ebikesAgeGrps[c(1,2,8,4,5,6,7,9,3),]

(bikesAgeGrps<-bind_cols(as.data.frame(ageGroupPropBike),as.data.frame(ageGroupPropCIBike)))
bikesAgeGrps <- bikesAgeGrps[c(1,2,8,4,5,6,7,9,3),]

(hoverAgeGrps<-bind_cols(as.data.frame(ageGroupProphover),as.data.frame(ageGroupPropCIhover)))
hoverAgeGrps <- hoverAgeGrps[c(1,2,7,3,4,5,6,8),]
hoverAgeGrps[9,]<-c(0,0,0,0)


(ageProps<-bind_rows(scootersAgeGrps, hoverAgeGrps, ebikesAgeGrps,bikesAgeGrps))
names(ageProps)<-c("Mean","SE", "CI.Lower", "CI.Upper")
ageProps
ageProps<-ageProps[-c(1,10,19,28),]

ageProps<-ageProps*100

ageProps

ageProps$Mode<-c(rep("Scooter",8), rep("Hover",8),rep("E-bike",8),rep("Bike",8))

ageProps$ageGroup<-rep(c("0 to 4", "5 to 9", "10 to 14", "15 to 17", "18 to 44", "45 to 64", "65 to 84", "85 and Older"),4)

ageProps


view(ageProps)
# side-by-side bar graph with 95% CI 

dodge <- position_dodge(width = 0.9)
limits <- aes(ymax = ageProps$CI.Upper, ymin = ageProps$CI.Lower)

level_order <- c("0 to 4", "5 to 9", "10 to 14", "15 to 17", "18 to 44", "45 to 64", "65 to 84", "85 and Older")

p <- ggplot(data = ageProps, aes(x = ageGroup, y = Mean, fill = Mode)) +
  geom_col(position = "fill") + 
  scale_y_continuous() +
  scale_x_discrete(limits = level_order)

p

#(p1<-p + geom_bar(stat = "identity", position = dodge)+geom_errorbar(limits, position = dodge, width = 0.25))
 
(p2<-p + theme_bw() + scale_fill_grey() + xlab("Age Groups") + ylab("Proportion"))

p2_ageall <-p2

p2
 
ggsave(file=" ",p2)
```


##descriptive tables

###table1

```{r}
#prep data for table 1 and 2
#create long format df 
df_long <- df_clean %>%
  pivot_longer(cols = c(bike, ebike, scooter, hover), names_to = "mode", values_to = "value")


# Filter rows where the value is 1
df_filtered <- df_long %>%
  filter(value == 1) %>%
  select(-c(value))

# make all categorical variables factors
df_filtered <- mutate_at(df_filtered, vars("mode", "age_cat_all","sex_cat", "race_cat", "hispanic_cat","location_cat", "alcohol_cat", "drug_cat", "disposition_cat"), as.factor)

#reorder factors
levels(df_filtered$age_cat_all)
df_filtered$age_cat_all <- factor(df_filtered$age_cat_all, levels = c("<5", "5-9","10-14", "15-17","18-44","45-64", "65-84", ">84"))
df_filtered$sex_cat <- factor(df_filtered$sex_cat, levels = c("Male","Female","Intersex/non-binary"))
```


Descriptive Characteristics for Micromobility Injuries in the National Electronic Injury
Surveillance System: United States, 2019–2022

```{r}

# define CI style
style_percent_1digits <- purrr::partial(gtsummary::style_percent, digits = 1)


# create single variable for helmet status
df_filtered$helmet_all <- case_when(df_filtered$helmet_negative == 1 ~ "No",
                                    df_filtered$helmet_positive == 1 ~ "Yes",
                                    df_filtered$helmet_unknown_all == 1 ~ NA)
df_filtered$helmet_all<-as.factor(df_filtered$helmet_all)

#determine % not missing for helmet status
# Specify the variable for which you want to calculate the percentage of non-missing values
variable_name <- "helmet_all"

# Calculate the percentage of non-missing values for the specified variable
percentage_non_missing <- sum(!is.na(df_filtered[[variable_name]])) / length(df_filtered[[variable_name]]) * 100

percentage_non_missing 
#use this code chunk to get not reported values in table, excluded because will not give % yes that were recorded 
# turn risk factor No level into "NA" b/c no is not recorded for these in Nemsis coding
#categorical_variables <- c("alcohol_cat", "drug_cat")
#binary_variables <- c("motorvehicle", "ped")

# Convert "No" to NA for categorical variables
#df_filtered <- df_filtered %>% 
#  mutate_at(vars(one_of(categorical_variables)), ~ #na_if(as.character(.), "No"))

# Convert 1 to NA for binary variables
#df_filtered <- df_filtered %>%
#  mutate_at(vars(one_of(binary_variables)), ~ #na_if(as.numeric(.), 0))

  
table1 <-
  survey::svydesign(id = ~psu ,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_filtered) %>%
  tbl_svysummary(by = mode,
                 include = c(age_cat_all, sex_cat, race_cat, hispanic_cat,location_cat,alcohol_cat, drug_cat,motorvehicle, ped, helmet_all),
    label = list(
                 age_cat_all ~ "Age",
                 sex_cat ~ "Sex",
                 race_cat ~ "Race",
                 hispanic_cat ~ "Ethnicity",
                 location_cat ~ "Location of injury",
                 alcohol_cat ~ "Alcohol use",
                 drug_cat ~ "Drug use",
                 motorvehicle ~ "Motor vehicle involved",
                 ped ~ "Pedestrian involved",
                 helmet_all ~ "Helmet use"),
    type = c(helmet_all, location_cat) ~ "categorical",
    missing_text = "Not reported",
    statistic = list(all_categorical() ~ "{p}"),
    digits = list(all_categorical() ~ c(1, 1))) %>%
  add_ci(pattern = "{stat} ({ci})",
         style_fun = everything() ~ style_percent_1digits)

#convert to word docx
%>%
as_flex_table() %>%
flextable::font(fontname = "Times", part = "all")%>%
flextable::set_table_properties(layout = "autofit")%>%
flextable::fontsize(size=12, part = "all") %>%
flextable::save_as_docx(path = "")

table1

```

###table2

Descriptive Characteristics of Disposition and Diagnoses for Micromobility Injuries in the
National Electronic Injury Surveillance System: United States, 2019–2022

```{r}
# define CI style
style_percent_1digits <- purrr::partial(gtsummary::style_percent, digits = 1)


table2 <-
  survey::svydesign(id = ~psu ,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_filtered) %>%
  tbl_svysummary(by = mode,
                 include = c(death, admitted, concussions, internal, fx, softTissue, burns, head),
    label = list(
                 death ~ "Died",
                 admitted ~ "Hospitalized",
                 concussions ~ "Concussion",
                 internal ~ "Internal",
                 fx ~ "Fractures",
                 softTissue ~ "Soft tissue",
                 burns ~ "Burns",
                 head ~ "Head injury"),
    missing_text = "Not reported",
    statistic = list(all_categorical() ~ "{p}"),
  digits = list(all_categorical() ~ c(2, 2))) %>%
  add_ci(pattern = "{stat} ({ci})",
         style_fun = everything() ~ style_percent_1digits)

#convert to word docx
%>% as_flex_table() %>%
flextable::font(fontname = "Times", part = "all") %>%
flextable::set_table_properties(layout = "autofit")%>%
flextable::fontsize(size=12, part = "all") %>%
flextable::save_as_docx(path = "") 


table2

```


##log-binomal regression models

###1) hospitalized (admitted)
```{r}
################################################################################################


# ADMITTED 
(scooterAdmitted<-svymean(~admitted , design=subset(surv, scooter==1),vartype = c( 'ci' , 'se' )) )

confint(scooterAdmitted)

 
(ebikeadmitted<-svymean(~admitted, design=subset(surv, ebike==1),vartype = c( 'ci' , 'se' )) )

confint(ebikeadmitted)
 
 
#ebike vs scooter admitted (NS)
svyttest(admitted~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
admitMod1<-svyglm(admitted~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link = "log"))

summary(admitMod1)
exp(cbind("PR"= coef(admitMod1), confint(admitMod1)))[2,]

 
#ebike vs hover admitted (SIG, ebike more likely)
svyttest(admitted~I(ebike==1), design=subset(surv,hover==1 | ebike==1))

admitMod2<-svyglm(admitted~I(ebike==1), design=subset(surv,hover==1 | ebike==1),family=binomial(link="log"))

summary(admitMod2)
exp(cbind("PR" = coef(admitMod2), confint(admitMod2)))[2,]


#ebike vs bike admitted (NS, but p=0.10)
svyttest(admitted~I(ebike==1), design=subset(surv,bike==1 | ebike==1))

admitMod3<-svyglm(admitted~I(ebike==1), design=subset(surv,bike==1 | ebike==1),family=binomial(link="log"))

summary(admitMod3)
exp(cbind("PR" = coef(admitMod3), confint(admitMod3)))[2,]
```



###2) died - estimates too small to report
```{r}
################################################################################################

# DIED

#ebike vs scooter death
svyttest(death~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
deathMod1<-svyglm(death~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link="log"))

summary(deathMod1)
exp(cbind("PR" = coef(deathMod1), confint(deathMod1)))[2,]



# SCOOTERS
# counts

(scooterDeaths<-svytotal(~death , design=subset(surv, scooter==1),vartype = c( 'ci' , 'se' )) )


confint(scooterDeaths)

(scooterdeath<-svymean(~death , design=subset(surv, scooter==1),vartype = c( 'ci' , 'se' )) )
4
scooterdeath*10000

 confint(scooterdeath)*10000

(ebikedeath<-svymean(~death, design=subset(surv, ebike==1),vartype = c( 'ci' , 'se' )) )


# using survey ratio approach
(propDeathScooter<-svyratio(~death, ~ct, subset(surv, scooter==1)))


propDeathScooter$ratio*10000

propDeathScooter$var*10000

confint(propDeathScooter)*10000

```


###3) internal injuries
```{r}

# internal 

#ebike vs scooter (SIG)
svyttest(internal~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(internal~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#ebike vs hover (SIG)
svyttest(internal~I(ebike==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(internal~I(ebike==1), design=subset(surv,hover==1 | ebike==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#ebike vs bike (SIG)
svyttest(internal~I(ebike==1), design=subset(surv,bike==1 | ebike==1))

Mod3<-svyglm(internal~I(ebike==1), design=subset(surv,bike==1 | ebike==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]

```



###4) soft tissue
```{r}

#ebike vs scooter (NSIG)
svyttest(softTissue~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(softTissue~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#ebike vs hover (SIG)
svyttest(softTissue~I(ebike==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(softTissue~I(ebike==1), design=subset(surv,hover==1 | ebike==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#ebike vs bike (NSIG)
svyttest(softTissue~I(ebike==1), design=subset(surv,bike==1 | ebike==1))

Mod3<-svyglm(softTissue~I(ebike==1), design=subset(surv,bike==1 | ebike==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]

```

###5) head
```{r}

# head

#ebike vs scooter (NSIG)
svyttest(head~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(head~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#ebike vs hover (SIG)
svyttest(head~I(ebike==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(head~I(ebike==1), design=subset(surv,hover==1 | ebike==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#ebike vs bike (NSIG)
svyttest(head~I(ebike==1), design=subset(surv,bike==1 | ebike==1))

Mod3<-svyglm(head~I(ebike==1), design=subset(surv,bike==1 | ebike==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]

```


##6) burns
```{r}


#ebike vs scooter (NSIG)
svyttest(burns~I(ebike==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(burns~I(ebike==1), design=subset(surv,scooter==1 | ebike==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#ebike vs hover (SIG)
svyttest(burns~I(ebike==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(burns~I(ebike==1), design=subset(surv,hover==1 | ebike==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#ebike vs bike (NSIG)
svyttest(burns~I(ebike==1), design=subset(surv,bike==1 | ebike==1))

Mod3<-svyglm(burns~I(ebike==1), design=subset(surv,bike==1 | ebike==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]

```
##7) fractures
```{r}

#hover vs scooter (SIG)
svyttest(fx~I(hover==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(fx~I(hover==1), design=subset(surv,scooter==1 | hover==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#hover vs ebike (SIG)
svyttest(fx~I(hover==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(fx~I(hover==1), design=subset(surv,ebike==1 | hover==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#hover vs bike (SIG)
svyttest(fx~I(hover==1), design=subset(surv,bike==1 | hover==1))

Mod3<-svyglm(fx~I(hover==1), design=subset(surv,bike==1 | hover==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]
```

##8) concussions

```{r}
#hover vs scooter (SIG)
svyttest(fx~I(hover==1), design=subset(surv,scooter==1 | ebike==1))

#subseted only the survey injuries and ebike injuries
Mod1<-svyglm(concussions~I(hover==1), design=subset(surv,scooter==1 | hover==1),family=binomial(link = "log"))

summary(Mod1)
exp(cbind("PR"= coef(Mod1), confint(Mod1)))[2,]

 
#hover vs ebike (SIG)
svyttest(concussions~I(hover==1), design=subset(surv,hover==1 | ebike==1))

Mod2<-svyglm(concussions~I(hover==1), design=subset(surv,ebike==1 | hover==1),family=binomial(link="log"))

summary(Mod2)
exp(cbind("PR" = coef(Mod2), confint(Mod2)))[2,]


#hover vs bike (SIG)
svyttest(concussions~I(hover==1), design=subset(surv,bike==1 | hover==1))

Mod3<-svyglm(concussions~I(hover==1), design=subset(surv,bike==1 | hover==1),family=binomial(link="log"))

summary(Mod3)
exp(cbind("PR" = coef(Mod3), confint(Mod3)))[2,]
```



##trends (count and population-based rate plots)

census data to generate population-based rates and plots derived from:https://data.census.gov/table/ACSST1Y2022.S0101?t=Age+and+Sex&g=010XX00US
5-year estimates for 2019, 2020, 2021. 1-year for 2022 (5-year not available)

###1) scooters

count scooter injuries over time
```{r}
#relevel ped age grps
df_clean$pedAgeGrp<-as.factor(df_clean$pedAgeGrp)
levels(df_clean$pedAgeGrp)
df_clean$pedAgeGrp <- factor(df_clean$pedAgeGrp, levels = c("0-4","5-9","10-14", "15-19", "Adult"))
levels(df_clean$pedAgeGrp)

surv<-svydesign(
		id = ~psu,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_clean
	)


################################################################################################
# COUNT SCOOTERS INJURIES OVER TIME


(scooterInjuriesquarter<-svyby(~scooter, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))


(scooterInjuriesYr<-svyby(~scooter, by=~yr, surv, svytotal, vartype = c( 'ci' , 'se' )))


scooterInjuriesYr$yr<-as.numeric(scooterInjuriesYr$yr)+2000

p<-ggplot(data=scooterInjuriesquarter, aes(x=yrQtr, y=scooter, ymin=ci_l, ymax=ci_u))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Count")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))

#ggsave(file="",p4)

```

###supplementary table 2, scooter 
population-based rate per year plot
```{r}
################################################################################################
# POPULATION-BASED RATES SCOOTER INJURIES
#https://data.census.gov/table/ACSST1Y2022.S0101?t=Age+and+Sex&g=010XX00US
#5-year estimates for 2019, 2020, 2021. 1-year for 2022 (5-year not available)

natPop <- c(324697795,326569308,329725481,333287562)

view(scooterInjuriesYr)

column_values <- scooterInjuriesYr$scooter

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas

count<- c(29269.6092, 28907.3146, 50066.0148, 56469.509)

ci.l <- c(14754.6513573749, 14315.61342457, 32293.0538481897, 39763.5940453809)

ci.u <-  c(43784.5670426251, 43499.01577543, 67838.9757518103, 73175.4239546192)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

popRate

p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Rate per 100,000 Population")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))



```

###rate of change
```{r}

view(popRate)
(popRate$Rate[4]-popRate$Rate[1])/popRate$Rate[1]*100  
# increased 88.0% between 2022 and 2019

```

## supplementary figure 1, scooter
population-based rate per year-quarter plot
```{r}
################################################################################################
# POPULATION-BASED RATES SCOOTER INJURIES

natPop <- c(324697795,324697795,324697795,324697795,326569308,326569308, 326569308,326569308,329725481,329725481,329725481,329725481,333287562,333287562,333287562,333287562)


# Select the column you want to list
column_values <- scooterInjuriesquarter$scooter

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas

count<- c(2879.7191, 8256.494, 12423.7903, 5709.6058, 3407.6943, 5742.3304, 12103.2297, 7654.0602, 5373.1126, 16571.092, 18172.9314, 9948.8788, 8100.7131, 18269.1217, 18622.0975, 11477.5767)

ci.l <- c(1239.57408298952, 3676.65037945367, 5600.69691270708, 2402.60700935288, 1270.62146224277, 3406.30258283697, 4170.25482682949, 3954.614410273, 3018.9167330304, 9522.00289664103, 11162.3281017859, 6790.72619365463, 5660.3877367063, 11128.9996232209, 13047.824586526, 7758.47180982565)

ci.u <-  c(4519.86411701048, 12836.3376205463, 19246.8836872929, 9016.60459064712, 5544.76713775723, 8078.35821716303, 20036.2045731705, 11353.505989727, 7727.30846696961, 23620.181103359, 25183.5346982141, 13107.0314063454, 10541.0384632937, 25409.2437767791, 24196.370413474, 15196.6815901744)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

# Create a sequence of year-quarter combinations
year_quarters <- data.frame(Year=rep(2019:2022, each=4), Quarter=1:4)

# Define your count, natPop, ci.l, and ci.u variables
# Assuming these are defined or imported into your script


# Calculate the Rate, Lower.CI, and Upper.CI columns
popRate <- data.frame(
  Year = paste(year_quarters$Year, "-", year_quarters$Quarter, sep=""),
  Rate = count / natPop * 100000,
  Lower.CI = ci.l / natPop * 100000,
  Upper.CI = ci.u / natPop * 100000
)


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("")+xlab("")+ ggtitle("Powered scooter"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1), method = "loess", color = "black", fill = "grey70"))

p4

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p4<- p4+ scale_x_discrete(label = labels)

p4_scooter <- p4

p4_scooter +
  scale_x_discrete(labels = labels) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    plot.title = element_text(size = 20)
  )



#ggsave("",p4)

```

###2) ebike

count of ebike injuries per year
```{r}
################################################################################################
# COUNT EBIKE INJURIES OVER TIME

(ebikeInjuriesYr<-svyby(~ebike, by=~yr, surv, svytotal, vartype = c( 'ci' , 'se' )))
ebikeInjuriesYr

(ebikeInjuriesyrQtr<-svyby(~ebike, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))


#ebikeInjuriesYr$yr<-as.numeric(ebikeInjuriesYr$yr)+2000

p<-ggplot(data=ebikeInjuriesyrQtr, aes(x=yrQtr, y=ebike, ymin=ci_l, ymax=ci_u))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Count")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))

#ggsave(file="",p4)

```

###supplementary table 2, ebike 
yearly rate of ebike injuries
```{r}
################################################################################################
# POPULATION-BASED RATES EBIKE INJURIES

view(ebikeInjuriesYr)
column_values <- ebikeInjuriesYr$ebike

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas


natPop <- c(324697795,326569308,329725481,333287562)

count<- c(5937.7358, 10345.0078, 16731.2252, 23949.2046)

ci.l <- c(2399.01978502855, 3061.58992764621, 8059.82767776653, 13579.1422986075)

ci.u <-  c(9476.45181497145, 17628.4256723538, 25402.6227222335, 34319.2669013925)


popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

popRate


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
p
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Rate per 100,000 Population")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))


view(popRate)
```

###rate of change
```{r}

(popRate$Rate[4]-popRate$Rate[1])/popRate$Rate[1]*100  
# increased 292.9438% between 2022 and 2019

(popRate$Rate[4]-popRate$Rate[3])/popRate$Rate[3]*100  
# increased 42% between 2022 and 2021

(popRate$Rate[3]-popRate$Rate[2])/popRate$Rate[2]*100  
# increased 60% between 2021 and 2020

(popRate$Rate[2]-popRate$Rate[1])/popRate$Rate[1]*100  
# increased 73% between 2020 and 2019
```

## supplementary figure 1, ebike
population-based rate per year-quarter plot
```{r}
################################################################################################
# POPULATION-BASED RATES ebike INJURIES

natPop <- c(324697795,324697795,324697795,324697795,326569308,326569308, 326569308,326569308,329725481,329725481,329725481,329725481,333287562,333287562,333287562,333287562)

view(ebikeInjuriesyrQtr)
# Select the column you want to list
column_values <- ebikeInjuriesyrQtr$ci_u

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas

count<- c(596.0438, 1552.7226, 2639.8298, 1149.1396, 1414.0082, 2647.3719, 3686.4339, 2597.1938, 2562.8549, 5114.5656, 5356.5034, 3697.3013, 3273.285, 7212.2126, 8244.127, 5219.58)

ci.l <- c(237.325694907044, 656.45618940626, 922.599708359249, 110.376497130985, 304.980426047319, 66.8964249321871, 1253.38834250114, 1027.71192552053, 1016.09708496849, 3184.16817821016, 1460.41323332471, 1822.60585569578, 1589.36695687368, 3943.9888263087, 4978.87227153311, 2007.80797523059)

ci.u <-  c(954.761905092956, 2448.98901059374, 4357.05989164075, 2187.90270286902, 2523.03597395268, 5227.84737506781, 6119.47945749886, 4166.67567447947, 4109.61271503151, 7044.96302178984, 9252.59356667529, 5571.99674430422, 4957.20304312632, 10480.4363736913, 11509.3817284669, 8431.35202476941)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

view(popRate)

# Create a sequence of year-quarter combinations
year_quarters <- data.frame(Year=rep(2019:2022, each=4), Quarter=1:4)

# Define your count, natPop, ci.l, and ci.u variables
# Assuming these are defined or imported into your script


# Calculate the Rate, Lower.CI, and Upper.CI columns
popRate <- data.frame(
  Year = paste(year_quarters$Year, "-", year_quarters$Quarter, sep=""),
  Rate = count / natPop * 100000,
  Lower.CI = ci.l / natPop * 100000,
  Upper.CI = ci.u / natPop * 100000
)

view(popRate)


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Rate per 100,000 Population")+xlab("Year") + ggtitle("E-bike"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1), method = "loess", color = "black", fill = "grey70"))

p4

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p4<- p4+ scale_x_discrete(label = labels)

p4_ebike <- p4

p4_ebike+
  scale_x_discrete(labels = labels) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    plot.title = element_text(size = 20)
  )


ggsave("",p4)

```


```{r}
(popRate$Rate[16]-popRate$Rate[1])/popRate$Rate[1]*100  
```


###3) bike

count bike over time
```{r}
################################################################################################
# COUNT BIKE INJURIES OVER TIME

(bikeInjuriesYr<-svyby(~bike, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))

bikeInjuriesYr$yr<-as.numeric(bikeInjuriesYr$yr)+2000

p<-ggplot(data=bikeInjuriesYr, aes(x=yrQtr, y=bike, ymin=ci_l, ymax=ci_u))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Count")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))

ggsave(file="",p4)


```

###supplementary table 2, bike
population-based rates 
```{r}
################################################################################################
# POPULATION-BASED RATES BIKE INJURIES


(bikeInjuriesYr<-svyby(~bike, by=~yr, surv, svytotal, vartype = c( 'ci' , 'se' )))

natPop <- c(324697795,326569308,329725481,333287562)

count<- bikeInjuriesYr$bike

ci.l <- bikeInjuriesYr$ci_l
 
ci.u <-  bikeInjuriesYr$ci_u

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

popRate


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
p
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Rate per 100,000 Population")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))


```

###rate of change
```{r}

(popRate$Rate[4]-popRate$Rate[1])/popRate$Rate[1]*100  
# decreased 5.5% between 2022 and 2019
```

## supplementary figure 1, bike
population-based rate per year-quarter plot
```{r}
################################################################################################
# POPULATION-BASED RATES BIKE INJURIES

(bikeInjuriesyrQtr<-svyby(~bike, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))

natPop <- c(324697795,324697795,324697795,324697795,326569308,326569308, 326569308,326569308,329725481,329725481,329725481,329725481,333287562,333287562,333287562,333287562)


# Select the column you want to list
column_values <- bikeInjuriesyrQtr$bike

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas

count<- c(63536.0531, 126426.2851, 148193.8629, 79193.263, 71467.0049, 129438.2166, 147167.3302, 77558.8835, 61753.3738, 124860.4882, 119387.9844, 69492.3236, 66088.936, 119374.1323, 145719.5699, 73485.4848)

ci.l <- c(35154.9774083455, 103117.061765917, 122233.516962569, 53308.1447568396, 41224.6308330186, 103269.877296283, 122477.282936241, 55898.70314452, 35894.8429585653, 99333.7569001795, 97642.3152259815, 49731.2733751115, 36148.0965152574, 91864.7487492511, 115221.675976492, 50400.7166020643)

ci.u <-  c(91917.1287916545, 149735.508434083, 174154.208837431, 105078.38124316, 101709.378966981, 155606.555903717, 171857.377463759, 99219.06385548, 87611.9046414347, 150387.21949982, 141133.653574019, 89253.3738248885, 96029.7754847426, 146883.515850749, 176217.463823508, 96570.2529979357)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

# Create a sequence of year-quarter combinations
year_quarters <- data.frame(Year=rep(2019:2022, each=4), Quarter=1:4)

# Define your count, natPop, ci.l, and ci.u variables
# Assuming these are defined or imported into your script


# Calculate the Rate, Lower.CI, and Upper.CI columns
popRate <- data.frame(
  Year = paste(year_quarters$Year, "-", year_quarters$Quarter, sep=""),
  Rate = count / natPop * 100000,
  Lower.CI = ci.l / natPop * 100000,
  Upper.CI = ci.u / natPop * 100000
)


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("")+xlab("") + ggtitle("Bicycle"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1), method = "loess", color = "black", fill = "grey70"))

p4

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p4<- p4+ scale_x_discrete(label = labels)

p4_bike <- p4 

p4_bike +
  scale_x_discrete(labels = labels) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    plot.title = element_text(size = 20)
  )





ggsave("",p4)
```


###4) hoverboard

count hoverboard over time
```{r}
################################################################################################
# COUNT hover board INJURIES OVER TIME


(hoverInjuriesYr<-svyby(~hover, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))

p<-ggplot(data=hoverInjuriesYr, aes(x=yrQtr, y=hover, ymin=ci_l, ymax=ci_u))
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Count")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))


ggsave(file="",p4)


```

###supplementary table 2, hover
population-based rate
```{r}
################################################################################################
# POPULATION-BASED RATES hover board INJURIES


(hoverInjuriesYr<-svyby(~hover, by=~yr, surv, svytotal, vartype = c( 'ci' , 'se' )))

natPop <- c(324697795,326569308,329725481,333287562)

count<- hoverInjuriesYr$hover

ci.l <- hoverInjuriesYr$ci_l
 
ci.u <-  hoverInjuriesYr$ci_u

view(hoverInjuriesYr)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

popRate


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI))
p
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("Rate per 100,000 Population")+xlab("Year"))
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1)))

```
###rate of change
```{r}

(popRate$Rate[4]-popRate$Rate[1])/popRate$Rate[1]*100  
# decreased 26.2% between 2022 and 2019
```

population-based rate per year-quarter plot
## supplementary figure 1, hover
```{r}

################################################################################################
# POPULATION-BASED RATES HOVER INJURIES

(hoverInjuriesyrQtr<-svyby(~hover, by=~yrQtr, surv, svytotal, vartype = c( 'ci' , 'se' )))

natPop <- c(324697795,324697795,324697795,324697795,326569308,326569308, 326569308,326569308,329725481,329725481,329725481,329725481,333287562,333287562,333287562,333287562)


# Select the column you want to list
column_values <- hoverInjuriesyrQtr$hover

# Use the paste function to concatenate the values with commas
values_with_commas <- paste(column_values, collapse = ', ')

values_with_commas

count<- c(5658.3044, 5207.7643, 4955.7806, 6052.544, 6912.1879, 6728.9286, 5494.5828, 7506.5976, 7179.815, 6008.6094, 4480.0536, 5728.1538, 5071.7715, 3829.274, 3981.6836, 3681.4036)

ci.l <- c(3598.67902615598, 3644.67955662507, 3379.81027316362, 3036.56034121123, 4656.16890503414, 4936.12000032055, 3877.44156395019, 4542.62849894476, 4015.84477817133, 3478.99335878039, 3193.35434060294, 3229.86274367444, 2705.91729394741, 2440.7945930117, 2464.77040211478, 1367.63766968447)

ci.u <-  c(7717.92977384402, 6770.84904337493, 6531.75092683638, 9068.52765878877, 9168.20689496586, 8521.73719967945, 7111.72403604981, 10470.5667010552, 10343.7852218287, 8538.22544121961, 5766.75285939706, 8226.44485632556, 7437.62570605259, 5217.7534069883, 5498.59679788522, 5995.16953031553)

popRate<-data.frame(Year=2019:2022,Rate=count/natPop*100000, Lower.CI=ci.l/natPop*100000, Upper.CI=ci.u/natPop*100000)

# Create a sequence of year-quarter combinations
year_quarters <- data.frame(Year=rep(2019:2022, each=4), Quarter=1:4)

# Define your count, natPop, ci.l, and ci.u variables
# Assuming these are defined or imported into your script


# Calculate the Rate, Lower.CI, and Upper.CI columns
popRate <- data.frame(
  Year = paste(year_quarters$Year, "-", year_quarters$Quarter, sep=""),
  Rate = count / natPop * 100000,
  Lower.CI = ci.l / natPop * 100000,
  Upper.CI = ci.u / natPop * 100000
)


p<-ggplot(data=popRate, aes(x=Year, y=Rate, ymin=Lower.CI, ymax=Upper.CI)) + ggtitle("Hoverboard")
(p2<-p+geom_point()+geom_errorbar()+theme_bw()+ylab("")+xlab("")+ scale_color_grey())
(p3<-p2+geom_line(aes(group=1)))
(p4<-p3+geom_smooth(aes(group=1), method = "loess", color = "black", fill = "grey70"))

p4

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p4<- p4+ scale_x_discrete(label = labels)

p4_hover <- p4 +
  scale_x_discrete(labels = labels) +
  theme(
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )

p4_hover


ggsave("",p4)
```

###supplementary figure 1

quarterly rate of e-bike, powered scooter, hoverboard, bicycle injuries treated in US emergency departments per 100 000 total US population.
```{r}

title <- textGrob("Quarterly rate of e-bike, powered scooter, hoverboard, bicycle injuries treated in US emergency departments per 100 000 total US population. ", gp = gpar(fontsize = 14, fontface = "bold"),x=0.025, hjust = 0)

# Arrange the individual plots
combined_plot <- arrangeGrob(p4_ebike, p4_scooter, p4_hover, p4_bike, ncol = 4, nrow = 1, widths = c(50, 50, 50, 50))

# Combine the title and the arranged plots
supp_figure1 <- grid.arrange(title, combined_plot, ncol = 1, heights = c(1, 10))

supp_figure1

ggsave("",supp_figure1, width = 20, height = 6, units = "in", dpi = 600)
```


###5) scooters x age
####population rate (quarter)
```{r}
################################################################################################
# COUNT SCOOTERS INJURIES OVER TIME BY AGE GROUP


# YEARLY COUNT BY AGE GROUP
(scooterInjuriesYrAge<-svyby(~scooter, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

#scooterInjuriesYrAge$yr<-as.numeric(scooterInjuriesYrAge$yr)+2000

view(scooterInjuriesYrAge)

p<-ggplot(data=scooterInjuriesYrAge, aes(x=yrQtr, y=scooter, ymin=ci_l, ymax=ci_u, color=ageGrp))
(p2<-p+geom_point()+geom_smooth()+theme_bw()+ylab("Count")+xlab("Year")+ guides(color=guide_legend(title="Age Groups")))

ggsave(file="", p2)
```

####population rate (year)
```{r}
################################################################################################
# POPULATION-BASED RATE SCOOTERS INJURIES OVER TIME BY AGE GROUP

(scooterInjuriesYrAge<-svyby(~scooter, ~yr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(scooterInjuriesYrAge)

ageGrps.long<-read.csv("data/census_data/ageGrps.long.csv")

scooterInjuriesYrAge <-scooterInjuriesYrAge %>%
  arrange(yr)

popDat1<-bind_cols(scooterInjuriesYrAge, ageGrps.long)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yr_1, ageGrp_1))

popDat1$Rate<-popDat1$scooter/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000


popDat1_test <- popDat1 %>% arrange(ageGrp, yr)


p<-ggplot(data=popDat1, aes(x=yr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p
```

####supplementary table 3
```{r}
view(popDat1_test)

df_rounded <- popDat1_test %>%
  mutate(across(where(is.numeric), round, 1))


df_rounded <- df_rounded  %>%
mutate(CI = paste("(", Rate.L, ", ", Rate.U, ")", sep = "")) %>%
  select(yr, ageGrp, Rate, CI)


# Export to Excel
write.xlsx(df_rounded,"")
```

#### figure 2, scooter plot

population rate (quarter)
```{r}

################################################################################################
# POPULATION-BASED RATE SCOOTERS INJURIES OVER TIME (quarters) BY AGE GROUP

(scooterInjuriesYrAge<-svyby(~scooter, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(scooterInjuriesYrAge)

ageGrps.long.quarters<-read.csv("data/census_data/ageGrps.long.quarters.csv")

scooterInjuriesYrAge <-scooterInjuriesYrAge %>%
  arrange(yrQtr)

popDat1<-bind_cols(scooterInjuriesYrAge, ageGrps.long.quarters)

view(popDat1)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yr_1, ageGrp_1))

popDat1$Rate<-popDat1$scooter/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

popDat1$yrQtr<-as.character(popDat1$yrQtr)

unique(popDat1$ageGrp)

popDat1$ageGrp <- factor(popDat1$ageGrp, levels = c("1.LT18", "2.GT17.LT45", "3.GT44.LT65", "4.GT64.LT85", "5.GT84"),labels = c("<18", "18-44", "45-64", "65-84", ">84"))

# remove >84
popDat1_test <- subset(popDat1, ageGrp != ">84")

view(popDat1_test)

p <- ggplot(data=popDat1_test, aes(x=yrQtr, y=Rate, group=ageGrp)) + 
  geom_point(aes(shape=ageGrp, color=ageGrp)) +
  geom_smooth(aes(color=ageGrp), se=FALSE, linetype="solid") +
  theme_bw() +
  ylab("") + 
  xlab("") + 
 guides(shape=guide_legend(title="Age Groups"), color=guide_legend(title="Age Groups")) +
  ggtitle("Powered scooter") +
  scale_shape_manual(values=c(16, 17, 18, 19, 20, 21, 22, 23, 24, 25)) +  # Customize shapes as needed
  scale_color_grey(start=0.2, end=0.8) +
   scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2)) # Customize the range of grayscales as needed

print(p)

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p2<- p+ scale_x_discrete(label = labels)

p2_escooter_age <-p2

p2_escooter_age

ggsave(file="",p2_escooter_age)

```



###6) ebikes x age
####population rate (quarter)
```{r}
################################################################################################
# COUNT EBIKES INJURIES OVER TIME BY AGE GROUP

# YEARLY COUNT BY AGE GROUP
(ebikeInjuriesYrAge<-svyby(~ebike, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))


#ebikeInjuriesYrAge$yr<-ebikeInjuriesYrAge$yr+2000

p<-ggplot(data=ebikeInjuriesYrAge, aes(x=yrQtr, y=ebike, ymin=ci_l, ymax=ci_u, color=ageGrp))
(p2<-p+geom_point()+geom_smooth()+theme_bw()+ylab("Count")+xlab("Year")+ guides(color=guide_legend(title="Age Groups")))

ggsave(file="", p2)
```

####population rate (year)
```{r}

(ebikeInjuriesYrAge<-svyby(~ebike, ~yr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

ebikeInjuriesYrAge <-ebikeInjuriesYrAge %>%
  arrange(yr)

popDat1<-bind_cols(ebikeInjuriesYrAge, ageGrps.long)

popDat1$Rate<-popDat1$ebike/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

p<-ggplot(data=popDat1, aes(x=yr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p
ggsave(file="", p2)
```

####supplementary table 3
```{r}
view(popDat1)

df_rounded <- popDat1%>%
  mutate(across(where(is.numeric), round, 1))


df_rounded <- df_rounded  %>%
mutate(CI = paste("(", Rate.L, ", ", Rate.U, ")", sep = "")) %>%
  select(yr, ageGrp, Rate, CI)


# Export to Excel
library(openxlsx)
write.xlsx(df_rounded, "")
```

####figure 2, ebike plot

```{r}
####population rate (quarter)

################################################################################################
# POPULATION-BASED RATE SCOOTERS INJURIES OVER TIME (quarters) BY AGE GROUP

# see censusDataUpdate2018 for census population count file creation

(ebikeInjuriesYrAge<-svyby(~ebike, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(ebikeInjuriesYrAge)

ageGrps.long.quarters<-read.csv("data/census_data/ageGrps.long.quarters.csv")

ebikeInjuriesYrAge <-ebikeInjuriesYrAge %>%
  arrange(yrQtr)

popDat1<-bind_cols(ebikeInjuriesYrAge, ageGrps.long.quarters)

view(popDat1)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yr_1, ageGrp_1))

popDat1$Rate<-popDat1$ebike/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

popDat1$yrQtr<-as.character(popDat1$yrQtr)

unique(popDat1$ageGrp)

popDat1$ageGrp <- factor(popDat1$ageGrp, levels = c("1.LT18", "2.GT17.LT45", "3.GT44.LT65", "4.GT64.LT85", "5.GT84"),labels = c("<18", "18-44", "45-64", "65-84", ">84"))

# remove >84
popDat1_test <- subset(popDat1, ageGrp != ">84")

p <- ggplot(data=popDat1_test, aes(x=yrQtr, y=Rate, group=ageGrp)) + 
  geom_point(aes(shape=ageGrp, color=ageGrp)) +
  geom_smooth(aes(color=ageGrp), se=FALSE, linetype="solid") +
  theme_bw() +
  ylab("Rate per 100,000 Population") + 
  xlab("Year") + 
   theme(legend.position = "none") +
  ggtitle("E-bike") +
  scale_shape_manual(values=c(16, 17, 18, 19, 20, 21, 22, 23, 24, 25)) +  # Customize shapes as needed
  scale_color_grey(start=0.2, end=0.8)+
   scale_y_continuous(limits = c(0, 8), breaks = seq(0, 8, by = 2))  # Customize the y-axis limits and break# Customize the range of grayscales as needed

print(p)

labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p2<- p+ scale_x_discrete(label = labels)

p2_ebike_age <-p2

p2_ebike_age 

ggsave(file="",p2)

```

###7) hover board x age
####population rate (quarter)
```{r}
################################################################################################
# COUNT HOVER INJURIES OVER TIME BY AGE GROUP

# YEARLY COUNT BY AGE GROUP
(hoverInjuriesYrAge<-svyby(~hover, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

p<-ggplot(data=hoverInjuriesYrAge, aes(x=yrQtr, y=hover, ymin=ci_l, ymax=ci_u, color=ageGrp))
(p2<-p+geom_point()+geom_smooth()+theme_bw()+ylab("Count")+xlab("Year")+ guides(color=guide_legend(title="Age Groups")))


```

####population rate (year)
```{r}

(hoverInjuriesYrAge<-svyby(~hover, ~yr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

hoverInjuriesYrAge <-hoverInjuriesYrAge %>%
  arrange(yr)

popDat1<-bind_cols(hoverInjuriesYrAge, ageGrps.long)

popDat1$Rate<-popDat1$hover/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

p<-ggplot(data=popDat1, aes(x=yr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p

```

####supplementary table 3
```{r}
view(popDat1)

df_rounded <- popDat1%>%
  mutate(across(where(is.numeric), round, 1))


df_rounded <- df_rounded  %>%
mutate(CI = paste("(", Rate.L, ", ", Rate.U, ")", sep = "")) %>%
  select(yr, ageGrp, Rate, CI)


# Export to Excel
write.xlsx(df_rounded, "")
```


####population rate (quarter)
```{r}

################################################################################################
# POPULATION-BASED RATE HOVER BOARD INJURIES OVER TIME (quarters) BY AGE GROUP


(hoverInjuriesYrAge<-svyby(~hover, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(hoverInjuriesYrAge)

ageGrps.long.quarters<-read.csv("data/census_data/ageGrps.long.quarters.csv")

hoverInjuriesYrAge <-hoverInjuriesYrAge %>%
  arrange(yrQtr)

popDat1<-bind_cols(hoverInjuriesYrAge, ageGrps.long.quarters)

view(popDat1)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yr_1, ageGrp_1))

popDat1$Rate<-popDat1$hover/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000


p<-ggplot(data=popDat1, aes(x=yrQtr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yrQtr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p

ggsave(file="",p)
```

####hover x pediatric age group

####population rate (quarter)
```{r}
################################################################################################
# YEARLY COUNT BY PEDIATRIC AGE GROUP


(hoverInjuriesYrAge2<-svyby(~hover, ~yrQtr+pedAgeGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

#hoverInjuriesYrAge2$yr<-as.numeric(hoverInjuriesYrAge2$yr)+2000

p<-ggplot(data=hoverInjuriesYrAge2, aes(x=yrQtr, y=hover, ymin=ci_l, ymax=ci_u, color=pedAgeGrp))
(p2<-p+geom_point()+geom_smooth()+theme_bw()+ylab("Count")+xlab("Year")+ guides(color=guide_legend(title="Pediatric Age Groups")))


```

####population rate (year)
```{r}

(hoverInjuriesYrAge<-svyby(~hover, ~yr+pedAgeGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))


view(hoverInjuriesYrAge)
hoverInjuriesYrAge <-hoverInjuriesYrAge %>%
  arrange(yr)
view(hoverInjuriesYrAge)

ageGrps.long <- read_excel("data/census_data/pedageGrps.long.xlsx")

popDat1<-bind_cols(hoverInjuriesYrAge, ageGrps.long)


popDat1 <-popDat1 %>% select(-c(yr_1, pedAgeGrp_1))

popDat1$Rate<-popDat1$hover/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

p<-ggplot(data=popDat1, aes(x=yr, y=Rate, color=pedAgeGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yr, y=Rate, group = pedAgeGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p


```

```{r}

################################################################################################
# POPULATION-BASED RATE HOVER BOARD INJURIES OVER TIME (quarters) BY PED AGE GROUP


(hoverInjuriesYrAge<-svyby(~hover, ~yrQtr+pedAgeGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(hoverInjuriesYrAge)
unique(hoverInjuriesYrAge$pedAgeGrp)


ageGrps.long.quarters<- read_excel("data/census_data/pedageGrps.long.quarters.xlsx")

view(ageGrps.long.quarters)

# Assuming df is your dataframe
hoverInjuriesYrAge$pedAgeGrp<- factor(hoverInjuriesYrAge$pedAgeGrp, levels = c("0-4", "5-9", "10-14", "15-19", "Adult"))

levels(hoverInjuriesYrAge$pedAgeGrp)


hoverInjuriesYrAge <-hoverInjuriesYrAge %>%
  arrange(pedAgeGrp)

popDat1<-bind_cols(hoverInjuriesYrAge, ageGrps.long.quarters)

view(popDat1)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yrQtr_1, pedAgeGrp_1))

popDat1$Rate<-popDat1$hover/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

popDat1$yrQtr<-as.character(popDat1$yrQtr)

# remove adult
popDat1 <- subset(popDat1, pedAgeGrp != "Adult")

p<-ggplot(data=popDat1, aes(x=yrQtr, y=Rate, color=pedAgeGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yrQtr, y=Rate, group = pedAgeGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+  guides(color=guide_legend(title="Pediatric Age Groups")) + ggtitle("Hoverboard")
 
p


labels<- c("2019", "","","","2020","","","","2021","","","","2022", "", "", "")

p2<- p+ scale_x_discrete(label = labels)

p2_hoverboard_age <-p2

ggsave(file="",p2)


```

####rate of change
```{r}

#5-9 year olds from 2022 to 2021 (Children)
(popDat1$Rate[32]-popDat1$Rate[25])/popDat1$Rate[25]*100  

#decreased 41% between 2022 and 2021

#10-14 year olds from 2022 to 2020 (adolescents)
(popDat1$Rate[48]-popDat1$Rate[37])/popDat1$Rate[37]*100  
# decreased 60% between 2022 and 2021
```


###8) bikes x age
####population rate (quarter)
```{r}
################################################################################################
# COUNT bikeS INJURIES OVER TIME BY AGE GROUP

# YEARLY COUNT BY AGE GROUP
(bikeInjuriesYrAge<-svyby(~bike, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))
view(bikeInjuriesYrAge)

#bikeInjuriesYrAge$yr<-bikeInjuriesYrAge$yr+2000

p<-ggplot(data=bikeInjuriesYrAge, aes(x=yrQtr, y=bike, ymin=ci_l, ymax=ci_u, color=ageGrp))
(p2<-p+geom_point()+geom_smooth()+theme_bw()+ylab("Count")+xlab("Year")+ guides(color=guide_legend(title="Age Groups")))


```

####population rate (year)
```{r}

(bikeInjuriesYrAge<-svyby(~bike, ~yr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

bikeInjuriesYrAge <-bikeInjuriesYrAge %>%
  arrange(yr)

popDat1<-bind_cols(bikeInjuriesYrAge, ageGrps.long)

popDat1$Rate<-popDat1$bike/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000

p<-ggplot(data=popDat1, aes(x=yr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p

```

####supplementary table 3
```{r}
view(popDat1)

df_rounded <- popDat1%>%
  mutate(across(where(is.numeric), round, 1))


df_rounded <- df_rounded  %>%
mutate(CI = paste("(", Rate.L, ", ", Rate.U, ")", sep = "")) %>%
  select(yr, ageGrp, Rate, CI)


# Export to Excel
write.xlsx(df_rounded, "")
```

####population rate (quarter)
```{r}

################################################################################################
# POPULATION-BASED RATE SCOOTERS INJURIES OVER TIME (quarters) BY AGE GROUP

# see censusDataUpdate2018 for census population count file creation

(bikeInjuriesYrAge<-svyby(~bike, ~yrQtr+ageGrp, surv, svytotal, vartype = c( 'ci' , 'se' )))

view(bikeInjuriesYrAge)

ageGrps.long.quarters<-read.csv("data/census_data/ageGrps.long.quarters.csv")

bikeInjuriesYrAge <-bikeInjuriesYrAge %>%
  arrange(yrQtr)

popDat1<-bind_cols(bikeInjuriesYrAge, ageGrps.long.quarters)

view(popDat1)

names(popDat1)

popDat1 <-popDat1 %>% select(-c(yr_1, ageGrp_1))

popDat1$Rate<-popDat1$bike/popDat1$value*100000
popDat1$Rate.L<-popDat1$ci_l/popDat1$value*100000
popDat1$Rate.U<-popDat1$ci_u/popDat1$value*100000



p<-ggplot(data=popDat1, aes(x=yrQtr, y=Rate, color=ageGrp,ymin=Rate.L, ymax=Rate.U)) + 
  geom_point()+
  #geom_line(aes(x=yr, y=Rate, group = ageGrp))+
  geom_smooth(aes(x=yrQtr, y=Rate, group = ageGrp))+
  theme_bw()+
  ylab("Rate per 100,000 Population")+xlab("Year")+        guides(color=guide_legend(title="Age Groups"))
 
p

ggsave(file="",p)

```

##figure 2, combine scooter and ebike plots

Figure 2. Quarterly rate of e-bike and powered scooter injuries per 100,000 US population by age in National Electronic Surveillance System, 2019-2022.
```{r}

figure2 <- grid.arrange(p2_ebike_age, p2_escooter_age, ncol = 2, nrow = 1,  widths = c(45, 55))
print(figure2)

ggsave("",figure2, width = 10, height = 6, units = "in", dpi = 300)

```


###resubmission additional analyses

helmet use x  head x age groups
```{r}

#1) create df that just includes head injury and helmet use reported

df_filtered$helmet_all[df_filtered$helmet_all == "(Missing)"] <- NA
df_head <- df_filtered %>%
  filter(head == 1 & helmet_all == "Yes")

#2) create table
  survey::svydesign(id = ~psu ,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_head) %>%
  tbl_svysummary(by = mode,
                 include = age_cat_all,
                 label = age_cat_all ~ "Age groups",
    missing = "no",
    statistic = list(all_categorical() ~ "{p}"),
  digits = list(all_categorical() ~ c(1, 1))) %>%
  add_ci(pattern = "{stat} ({ci})",
         style_fun = everything() ~ style_percent_1digits)

  
#to print out docx
as_flex_table() %>%
flextable::font(fontname = "Times", part = "all") %>%
flextable::set_table_properties(layout = "autofit")%>%
flextable::fontsize(size=12, part = "all") %>%
flextable::save_as_docx(path ="")

    
  
```

```{r}
##helmet use x  head x age groups

df_filtered$helmet_all[df_filtered$helmet_all == "(Missing)"] <- NA
df_helmet <- df_filtered %>%
  filter(helmet_all == "Yes")

#2) create table
  survey::svydesign(id = ~psu ,
		strata = ~interaction(stratum,yr) ,
		weights = ~weight ,
		nest = TRUE,
		data = df_helmet) %>%
  tbl_svysummary(by = mode,
                 include = yr,
                 label = yr ~ "year",
    missing = "no",
    statistic = list(all_categorical() ~ "{p}"),
  digits = list(all_categorical() ~ c(1, 1))) %>%
  add_ci(pattern = "{stat} ({ci})",
         style_fun = everything() ~ style_percent_1digits)
```

